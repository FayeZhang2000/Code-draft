<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>report page</title>
    <link rel="stylesheet" href="report_Activation.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  </head>

  <body>
    <div class="header">header</div>
    <div class="nav">nav</div>
    <div class="report-container">
      <div class="action">
        <div class="dropdown">
          <button class="dropdown-toggle">
            <i class="bi bi-file-earmark-bar-graph"></i> Activation &
            Termination Report
          </button>
          <div class="dropdown-menu">
            <button onclick="window.location.href='/report';">
              Ticket Report
            </button>
            <button onclick="window.location.href='/report_Activation';">
              Activation & Termination Report
            </button>
          </div>
        </div>

        <div class="dropdown">
          <button class="dropdown-toggle">
            <i class="bi bi-file-earmark-arrow-down"></i> Export
          </button>
          <div class="dropdown-menu">
            <button onclick="$('.copy-btn').click();">
              Export to Clipboard
            </button>
            <button onclick="$('.excel-btn').click();">Export to Excel</button>
            <button onclick="$('.csv-btn').click();">Export to CSV</button>
          </div>
        </div>
      </div>

      <div class="filter">
        <div class="date-range">
          <label>From</label>
          <input type="date" class="filter-date" />
          <label>To</label>
          <input type="date" class="filter-date" />
        </div>
        <button class="filter-apply">Apply</button>
      </div>
      <!-- chart  -->
      <div class="banner">
        <!-- UP chart left -->
        <div class="left-chart">
          <canvas id="activityChart"></canvas>
        </div>
        <!-- UP chart right -->
        <div class="right-chart">
          <div class="chart-container">
            <canvas id="plansChart"></canvas>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="table-section">
          <p class="table-title">Survey Details</p>
          <table class="styled-table">
            <thead>
              <tr>
                <th><input type="checkbox" /></th>
                <th>Branch</th>
                <th>Carrier</th>
                <th>Agent</th>
                <th>Staff</th>
                <th>Act.Date</th>
                <th>Client #</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="checkbox" /></td>
                <td>1001</td>
                <td>John hang</td>
                <td>
                  <div class="satisfaction-level5">5</div>
                </td>
                <td>Excellent service!</td>
                <td>2024-01-01</td>
                <td>2024-01-01</td>
              </tr>
              <tr>
                <td><input type="checkbox" /></td>
                <td>1002</td>
                <td>John hang</td>
                <td>
                  <div class="satisfaction-level5">5</div>
                </td>
                <td>Good experience.</td>
                <td>2024-01-02</td>
                <td>2024-01-02</td>
              </tr>
              <tr>
                <td><input type="checkbox" /></td>
                <td>1002</td>
                <td>John hang</td>
                <td>
                  <div class="satisfaction-level1">1</div>
                </td>
                <td>Good experience.</td>
                <td>2024-01-02</td>
                <td>2024-01-02</td>
              </tr>
              <tr>
                <td><input type="checkbox" /></td>
                <td>1002</td>
                <td>John hang</td>
                <td>
                  <div class="satisfaction-level3">3</div>
                </td>
                <td>Good experience.</td>
                <td>2024-01-02</td>
                <td>2024-01-02</td>
              </tr>
              <tr>
                <td><input type="checkbox" /></td>
                <td>1002</td>
                <td>John hang</td>
                <td>
                  <div class="satisfaction-level5">5</div>
                </td>
                <td>Good experience.</td>
                <td>2024-01-02</td>
                <td>2024-01-02</td>
              </tr>
              <tr>
                <td><input type="checkbox" /></td>
                <td>1002</td>
                <td>John hang</td>
                <td>
                  <div class="satisfaction-level4">4</div>
                </td>
                <td>Good experience.</td>
                <td>2024-01-02</td>
                <td>2024-01-02</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- table  -->
    </div>
  </body>

  <script>
    //left chart
    //chart 7
    const ctx = document.getElementById("activityChart").getContext("2d");

    const gradientActivations = ctx.createLinearGradient(0, 0, 0, 400);
    gradientActivations.addColorStop(0, "rgba(0, 123, 255, 0.3)");
    gradientActivations.addColorStop(0.5, "rgba(255, 255, 255, 0.5)");
    gradientActivations.addColorStop(1, "rgba(255, 255, 255, 1)");

    const gradientSuspended = ctx.createLinearGradient(0, 0, 0, 400);
    gradientSuspended.addColorStop(0, "rgba(0, 56, 168, 0.3)");
    gradientSuspended.addColorStop(0.5, "rgba(255, 255, 255, 0.5)");
    gradientSuspended.addColorStop(1, "rgba(255, 255, 255, 1)");

    const gradientTermination = ctx.createLinearGradient(0, 0, 0, 400);
    gradientTermination.addColorStop(0, "rgba(173, 216, 230, 0.3)");
    gradientTermination.addColorStop(0.5, "rgba(255, 255, 255, 0.5)");
    gradientTermination.addColorStop(1, "rgba(255, 255, 255, 1)");

    new Chart(ctx, {
      type: "line",
      data: {
        labels: [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ],
        datasets: [
          {
            label: "Activity",
            data: [100, 200, 150, 300, 400, 500, 250, 270, 300, 320, 350, 300],
            borderColor: "#B3E5FC",
            backgroundColor: gradientTermination,
            fill: true,
            tension: 0.3,
            borderWidth: 1,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "#B3E5FC",
          },
          {
            label: "Suspended",
            data: [150, 200, 150, 200, 200, 350, 200, 150, 350, 150, 350, 200],
            borderColor: "#2887E7",
            backgroundColor: gradientActivations,
            fill: true,
            tension: 0.3,
            borderWidth: 1,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "#2887E7",
          },
          {
            label: "Terminations",
            data: [150, 200, 200, 150, 350, 200, 200, 150, 350, 150, 350, 200],
            borderColor: "#00286B",
            backgroundColor: gradientSuspended,
            fill: true,
            tension: 0.3,
            borderWidth: 1,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "#00286B",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "nearest",
          intersect: false,
        },
        plugins: {
          legend: {
            display: true,
            labels: {
              font: {
                size: 10,
              },
            },
          },
          title: {
            display: true,
            text: "Activity",
            align: "start",
            font: { size: 12, weight: "bold" },
            color: "#263238", // 添加标题颜色
          },

          tooltip: {
            callbacks: {
              title: function (context) {
                return context[0].label;
              },
              label: function (context) {
                const label = context.dataset.label || "";
                return `${label}: ${context.raw}`;
              },
              footer: function () {
                return "";
              },
            },
            displayColors: false,
            bodySpacing: 4,
            padding: 10,
            backgroundColor: "white",
            titleFont: {
              size: 12,
              weight: "bold",
              family: "'inter', sans-serif",
            },
            bodyFont: {
              size: 10,
              family: "'inter', sans-serif",
            },
            titleColor: "#263238",
            bodyColor: "#607D8B",
            borderColor: "#F4F2F7",
            borderWidth: 1,
          },
        },
        scales: {
          x: {
            ticks: {
              font: {
                size: 10,
                family: "'Inter', sans-serif",
              },
              color: "#475467",
            },
            grid: {
              display: false,
            },
          },
          y: {
            ticks: {
              font: {
                size: 10,
                family: "'Inter', sans-serif",
              },
              color: "#475467",
              grid: {
                color: "#F4F2F7",
              },
            },
          },
        },
      },
    });
    //chart 8
    const plansCtx = document.getElementById("plansChart").getContext("2d");

    // 原始数据
    const data = {
      labels: ["Plan 1", "Plan 2", "Plan 3"],
      datasets: [
        {
          data: [40056, 29000, 50000], // 实际数据
          backgroundColor: [
            "rgba(0, 56, 168, 0.9)",
            "rgba(0, 123, 255, 0.7)",
            "rgba(173, 216, 230, 0.8)",
          ],
          borderColor: "#fff",
          borderWidth: 2,
        },
      ],
    };

    // 计算总和
    const total = data.datasets[0].data.reduce((acc, value) => acc + value, 0);

    const customLabels = [];

    // 创建饼图
    const chart = new Chart(plansCtx, {
      type: "pie",
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 5, // 顶部间距
            bottom: 20, // 底部间距，避免被遮挡
          },
        },
        plugins: {
          title: {
            display: true, // 确保标题显示
            text: "Plans", // 设置标题内容
            align: "start", // 靠左对齐
            position: "top", // 标题位置
            font: {
              size: 12, // 标题字体大小
              weight: "bold", // 标题加粗
            },
            color: "#263238", // 标题颜色
            padding: {
              top: 5,
              left: 10, // 左边距
            },
          },
          legend: {
            display: false, // 隐藏默认图例
          },
          tooltip: {
            enabled: false, // 禁用默认工具提示
          },
        },
        animation: {
          animation: false, // 禁用所有动画，包括初始化和 hover 动画
          onComplete: function () {
            // 自定义标签
            const chartInstance = this;
            const ctx = chartInstance.ctx;
            const meta = chartInstance.getDatasetMeta(0);

            // 清理上次的标签
            customLabels.forEach((label) => label.remove());
            customLabels.length = 0;

            meta.data.forEach((arc, index) => {
              const center = arc.tooltipPosition();
              const value = chartInstance.data.datasets[0].data[index];
              const percentage = ((value / total) * 100).toFixed(1);

              // 创建自定义标签
              const customLabel = document.createElement("div");
              customLabel.className = "custom-label";
              customLabel.style.left = `${center.x}px`;
              customLabel.style.top = `${center.y}px`;

              // 添加标题（总数）和百分比
              customLabel.innerHTML = `
            <div style=" font-size: 10px; font-weight: bold; color: #888888;">
              ${value.toLocaleString()}
            </div>
            <div style="background-color: #ECEFF1; padding: 4px; border-radius: 4px; font-size: 12px; color: #45A64; margin-top: 4px;">
              ${percentage}%
            </div>
          `;

              // 添加标签到图表容器
              plansCtx.canvas.parentNode.appendChild(customLabel);
              customLabels.push(customLabel);
              meta.data.forEach((arc, index) => {
                const label = chartInstance.data.labels[index];
                const color =
                  chartInstance.data.datasets[0].backgroundColor[index];

                // 计算扇区中心角度
                const angle = (arc.startAngle + arc.endAngle) / 2;

                // 折线开始的位置，紧贴饼图边缘
                const radius = arc.outerRadius; // 从外边缘开始
                const lineStart = {
                  x: arc.x + Math.cos(angle) * radius,
                  y: arc.y + Math.sin(angle) * radius,
                };

                // 折线的中点位置 (调整弯折的程度)
                const lineMid = {
                  x: lineStart.x + Math.cos(angle) * 10, // 调整为 20 控制折线长度
                  y: lineStart.y + Math.sin(angle) * 10,
                };

                // 折线的文字终点 (更短的水平延伸)
                const textEnd = {
                  x: lineMid.x + (angle < Math.PI ? 30 : -30), // 调整为 40 控制文字位置
                  y: lineMid.y,
                };

                // 绘制折线
                ctx.beginPath();
                ctx.moveTo(lineStart.x, lineStart.y);
                ctx.lineTo(lineMid.x, lineMid.y);
                ctx.lineTo(textEnd.x, textEnd.y);
                ctx.strokeStyle = color;
                ctx.lineWidth = 1.5;
                ctx.stroke();

                // 添加文本
                ctx.fillStyle = "#263238";
                ctx.font = "12px sans-serif";
                ctx.textAlign = angle < Math.PI ? "left" : "right";

                // 调整文字与折线的距离
                const textOffset = 6; // 减少间距
                const textX =
                  textEnd.x + (angle < Math.PI ? textOffset : -textOffset);
                const textY = textEnd.y;

                ctx.fillText(`${label}`, textX, textY); // 只显示 Plan 标签
              });
            });
          },
        },
      },
    });
  </script>
</html>
